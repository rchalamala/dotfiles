#!/usr/bin/env bash

set -euo pipefail

eval "$(/opt/homebrew/bin/brew shellenv)"

{{ template "env.tmpl" . -}}

sudo -v
if [ ! -f /etc/pam.d/sudo_local ]; then
	sudo cp /etc/pam.d/sudo_local.template /etc/pam.d/sudo_local
	sudo sed -i '' "s/^#auth       sufficient     pam_tid.so/auth       sufficient     pam_tid.so/" /etc/pam.d/sudo_local
fi

brew install rcmdnk/file/brew-file zsh fish
BREW_PREFIX="$(brew --prefix)"
chmod go-w "${BREW_PREFIX}/share"
chmod -R go-w "${BREW_PREFIX}/share/zsh"
chmod -R go-w "${BREW_PREFIX}/share/fish"

ZSH_PATH="${BREW_PREFIX}/bin/zsh"
if ! grep -q "${ZSH_PATH}" /etc/shells; then
	echo "${ZSH_PATH}" | sudo tee -a /etc/shells
fi

FISH_PATH="${BREW_PREFIX}/bin/fish"
if ! grep -q "${FISH_PATH}" /etc/shells; then
	echo "${FISH_PATH}" | sudo tee -a /etc/shells
fi

if [ "$SHELL" != "${FISH_PATH}" ]; then
	sudo chsh -s "${FISH_PATH}" "$USER"
fi

brew file install

brew completions link
mise trust -y ~/.config/mise.toml
osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true

defaults write NSGlobalDomain AppleShowAllExtensions -bool true
defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false
defaults write NSGlobalDomain InitialKeyRepeat -int 15
defaults write NSGlobalDomain KeyRepeat -int 2
defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false
defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticInlinePredictionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false
defaults write NSGlobalDomain NSSmartReplyEnabled -bool false
defaults write NSGlobalDomain WebAutomaticSpellingCorrectionEnabled -bool false
defaults delete NSGlobalDomain NSUserDictionaryReplacementItems 2>/dev/null || true

defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

defaults delete com.apple.dock persistent-apps 2>/dev/null || true
defaults delete com.apple.dock persistent-others 2>/dev/null || true
defaults write com.apple.dock autohide -bool true
defaults write com.apple.dock autohide-delay -float 0
defaults write com.apple.dock autohide-time-modifier -float 0
defaults write com.apple.dock show-recents -bool false
defaults write com.apple.dock workspaces-auto-swoosh -bool false

defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"
defaults write com.apple.finder _FXSortFoldersFirst -bool true
defaults write com.apple.finder NewWindowTarget -string "PfHm"

defaults write com.apple.menuextra.clock ShowSeconds -bool true
defaults write com.apple.menuextra.battery ShowPercent -string "YES"
defaults write com.apple.screencapture target -string "clipboard"

sudo chflags nohidden /Volumes

killall Dock
killall Finder
killall SystemUIServer
